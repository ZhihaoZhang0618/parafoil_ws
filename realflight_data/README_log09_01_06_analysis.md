# Parafoil Log Analysis — 2.3m parafoil — 09_01_06

| 项目 | 值 |
|---|---|
| 日志文件 | `logs/09_01_06.ulg` |
| 分析日期 | 2025-12-31 |
| 分析脚本 | `scripts/analyze_log09_01_06.py` |
| 输出JSON | `outputs/log09_01_06_analysis/analysis.json` |

> **分析目的**: 提取无动力滑翔伞的性能参数（滑翔比、下降率、转弯半径），为 L1 导航降落程序提供数据支持

## 快速复现
- 运行：`/home/aims/parafoilData/.venv/bin/python scripts/analyze_log09_01_06.py`
- 结果JSON：`outputs/log09_01_06_analysis/analysis.json`

## 作为未来分析的 Prompt（复用说明）
- 若要分析新的日志：复制本文件为 `README_log<新日志>_analysis.md`，复制脚本为 `scripts/analyze_log<新日志>.py`，并更新脚本里的 `LOG_FILE` 与 `SEGMENTS`。
- 运行脚本后：用脚本打印出的 Markdown 表格更新 README（结论摘要、分段结果、直飞子样本、刹车分箱、估风、roll=0 检查）。
- 输出要求（写入 README）：明确区分 **对地** 与 **对空** 指标；说明过滤阈值；对“重刹车样本是否被修正/转弯污染”给出可靠性判断与采集建议。

### Prompt 模板（可直接复制给 Codex）
```text
任务: 分析新的 parafoil PX4 ULog（无动力滑翔），并把结果写入对应的 README。

输入:
- log_file: logs/<xxx>.ulg
- segments:  # 单位秒，按你的飞行操作挑“稳态直飞/转弯测试/修正”等典型段
  - {name: 段1, start: 0, end: 0, note: ""}
  - {name: 段2, start: 0, end: 0, note: ""}

输出:
1) 新增/更新脚本 `scripts/analyze_log<xxx>.py`
   - 用 `/home/aims/parafoilData/.venv/bin/python` 可直接运行
   - 生成 `outputs/log<xxx>_analysis/analysis.json`
   - 终端打印可直接粘贴到 README 的 Markdown 表格
2) 更新 `README_log<xxx>_analysis.md`（结构参考本文件）
   - 必含: 结论摘要 / 分段结果 / 直飞子样本 / 刹车分箱(严格+放宽) / 估风与对空粗估 / roll=0 对称性检查 / 建议后续采集

约束与口径:
- 指标默认给“对地”；若估风可信，再给“对空”粗估，并明确可靠性与误差来源。
- “重刹车”必须检查样本是否被差动刹车/修正污染（看 `servo_diff` 与 `yaw_rate(gyro)`），避免把转弯/非稳态当作直飞极线点。
```

## 结论摘要
- 本文滑翔比默认均为 **对地** `h_speed / sink_rate`；风会显著改变 `h_speed`，因此对地滑翔比只可做“落点规划保守估计”。
- 直飞可用段：段1/段2（中刹车，`brake_ratio≈0.50`）和段3（松刹车，`brake_ratio≈0.00`）；段4/5/6 主要是转弯/修正，不适合作为直飞极线点。
- RC→Servo 映射在本 log 内高度一致：pitch 控制 `servo_avg`、roll 控制 `servo_diff`（见下表），因此用 `servo_avg` 计算刹车率是可靠的。
- 中刹车估风：风“来向”约 **6.6°（北风略偏东北）**，风速约 **0.61 m/s**；据此中刹车空速约 **4.3 m/s**，对空滑翔比粗估约 **4.7**（仅供参考）。
- 刹车率关系：松刹车与中刹车性能接近；“重刹车”分箱变化明显主要因样本多来自修正/弱转弯（大 `servo_diff`），可靠性低于松/中刹车。
- 导航落点（保守建议）：若只用本 log 作为初值，可先用中刹车对空 `V≈4.3 m/s, sink≈0.9 m/s, L/D≈4.7`；后续用专门“对称直飞”数据再更新极线。

## 关注点与时间段（用户指定）
- 目标1：不同刹车率下的滑翔比与下降率
- 目标2：当 `roll=0` 时是否存在“固定偏航/左右刹车不对称”
- 时间段：
  - 267–278：中刹车（ch3油门≈0，pitch≈中位）
  - 317–340：中刹车（有 roll 修正，但总刹车量应基本不变）
  - 371–383：松刹车（381s 轻微修正）
  - 400–419：pitch 全推（意图松刹车）+ 大差动（转弯测试，实际 `brake_ratio≈0.23`）
  - 457–463：pitch 全拉（全刹车）+ 差动修正（非稳态）
  - 480–493：pitch 全拉（全刹车）+ 差动修正（转弯测试，非稳态）

---

## 数据定义与计算（本文约定）
- 时间基准: `sys_time = timestamp / 1e6`
- 坐标/符号: PX4 `vehicle_local_position` 为 NED；`altitude = -z`；`sink_rate = vz`（向下为正，单位 m/s）
- 速度与航向:
  - `h_speed = sqrt(vx^2 + vy^2)`（水平地速模长）
  - `heading_deg = atan2(vy, vx)`（基于速度方向的航向，单位°）
  - `turn_rate_track = d(unwrap(heading))/dt`（°/s，对地航向变化，低空速/大风时会受影响）
  - `yaw_rate(gyro) = deg(vehicle_angular_velocity.xyz[2])`（°/s，更适合判断是否在“转弯/摆动”）
- 刹车量（servo）:
  - `servo1 = control[0]`（左刹车），`servo2 = control[1]`（右刹车）
  - `servo_avg = (servo1 + servo2) / 2`（刹车总量）
  - `servo_diff = servo2 - servo1`（刹车差，正值=右刹车更多）
  - `brake_ratio = (servo_avg + 1) / 2`（0=松刹车，1=全刹车）
- 统计口径:
  - 分段表：10% 截尾均值（抗短时修正）
  - “刹车率-性能关系”：按刹车比区间统计中值；每个区间样本数 < 20 记为 N/A；转弯过滤优先用 `yaw_rate(gyro)` 平滑值
- 本文滑翔比为 **对地** `h_speed / sink_rate`；如需对空极线，推荐“相反航向成对”估风后再计算空速

## RC→Servo 映射校验（用于检查“中/松/全刹车”分段是否匹配实际舵机）
基于无动力数据点（throttle<-0.8, altitude>3m, h_speed>1.5m/s）线性回归：

| 映射 | 样本 | 线性模型 | r |
|---|---:|---|---:|
| pitch → servo_avg | 1020 | `servo_avg = -0.793 * pitch - 0.003` | -0.963 |
| roll → servo_diff | 1020 | `servo_diff = 1.323 * roll - 0.035` | 0.931 |

## 分段结果（按用户指定时间段，默认对地）
| 段 | 时间(s) | 样本 | Servo1 | Servo2 | 刹车总量 | 刹车差 | 刹车比 | H速度 | 下降率 | 滑翔比 | 转弯率(track) | yaw_rate(gyro) | 航向 | 备注 |
|---|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---|
| 段1 中刹车 | 267-278 | 110 | -0.04 | +0.04 | +0.00 | +0.08 | 0.50 | 4.07 | 1.07 | 3.79 | 1.3 | 0.3 | -74.9 | pitch中位 |
| 段2 中刹车 | 317-340 | 230 | -0.01 | +0.01 | +0.00 | +0.01 | 0.50 | 4.78 | 0.87 | 5.52 | -1.2 | -0.6 | 142.6 | roll修正但总刹车量基本不变 |
| 段3 松刹车 | 371-383 | 120 | -0.99 | -1.00 | -1.00 | -0.00 | 0.00 | 4.29 | 0.81 | 5.31 | -1.0 | -0.3 | -28.8 | 381s轻微修正 |
| 段4 松刹车 | 400-419 | 190 | -1.00 | -0.15 | -0.57 | +0.83 | 0.22 | 3.60 | 1.05 | 3.43 | 6.4 | 5.4 | 146.7 | 转弯测试（大差动） |
| 段5 全刹车 | 457-463 | 60 | +0.62 | +1.00 | +0.80 | +0.31 | 0.90 | 4.87 | 1.01 | 4.82 | -11.0 | -5.4 | 93.7 | 非稳态修正 |
| 段6 全刹车 | 480-493 | 130 | +0.43 | +1.00 | +0.71 | +0.51 | 0.86 | 2.26 | 1.22 | 1.86 | 3.2 | 1.1 | -163.0 | 转弯/修正（非稳态） |

## 分段稳定性与直飞子样本（更适合取“稳态性能点”）
对每段再取子样本：`|servo_diff| < 0.2` 且 `|yaw_rate(gyro)| < 5°/s`（近似“对称 + 非剧烈摆动/转弯”），用中值统计：

| 段 | 时间(s) | 样本(总/用) | 刹车比中值 | H速度中值 | 下降率中值 | 滑翔比 |
|---|---|---:|---:|---:|---:|---:|
| 段1 中刹车 | 267-278 | 110/63 | 0.50 | 4.18 | 1.10 | 3.80 |
| 段2 中刹车 | 317-340 | 230/105 | 0.50 | 4.75 | 0.84 | 5.67 |
| 段3 松刹车 | 371-383 | 120/62 | 0.00 | 4.33 | 0.87 | 4.98 |

说明：
- 段1/2/3 的刹车比非常稳定（p10/p50/p90 都基本锁定在对应档位），分段判断正确
- 段1/2 里存在少量大幅度方向修正点，因此用“直飞子样本”做性能统计更稳妥
- 段4/5/6 本质是转弯/修正段，不适合当作直飞极线点

## 刹车率-下降率-滑翔比关系（近似统计）
为获得“刹车率 → (下降率, 地速, 对地滑翔比)”的粗略关系，对所有无动力数据按刹车比 `brake_ratio` 分箱统计。  
考虑到你在抗风时会用 roll 修正，这里给出两套过滤条件：
- **严格直飞过滤**：更接近稳态直飞，但可能补不到重刹车样本
- **放宽过滤（用于补重刹车）**：允许较大 roll/刹车差用于修正，但仍限制 `|yaw_rate(gyro)| < 8°/s` 避免强转弯

### 严格直飞过滤
过滤条件: throttle < -0.8、altitude > 3m、h_speed > 1.5m/s、|roll| < 0.1、|servo_diff| < 0.2、|yaw_rate(gyro)| < 8°/s  
按刹车比区间统计中值；样本数 < 20 记为 N/A。

| 刹车比区间 | 样本 | 刹车比中值 | 下降率中值 | H速度中值 | 滑翔比 |
|---|---:|---:|---:|---:|---:|
| 0-0.2 | 110 | 0.00 | 0.82 | 4.20 | 5.11 |
| 0.2-0.4 | 3 | N/A | N/A | N/A | N/A |
| 0.4-0.6 | 246 | 0.50 | 0.90 | 4.46 | 4.97 |
| 0.6-0.8 | 1 | N/A | N/A | N/A | N/A |
| 0.8-1.0 | 19 | N/A | N/A | N/A | N/A |

### 放宽过滤（用于补重刹车）
过滤条件: throttle < -0.8、altitude > 3m、h_speed > 1.5m/s、|roll| < 0.7、|servo_diff| < 1.0、|yaw_rate(gyro)| < 8°/s  
按刹车比区间统计中值；样本数 < 20 记为 N/A。

| 刹车比区间 | 样本 | 刹车比中值 | 下降率中值 | H速度中值 | 滑翔比 |
|---|---:|---:|---:|---:|---:|
| 0-0.2 | 136 | 0.00 | 0.85 | 4.27 | 5.01 |
| 0.2-0.4 | 4 | N/A | N/A | N/A | N/A |
| 0.4-0.6 | 288 | 0.50 | 0.86 | 4.49 | 5.22 |
| 0.6-0.8 | 1 | N/A | N/A | N/A | N/A |
| 0.8-1.0 | 42 | 0.92 | 1.32 | 2.81 | 2.14 |

如何解读（重点解释“重刹车很不线性”）：
- 在该 log 里，`brake_ratio≈0.0` 与 `≈0.5` 的差异很小：要么真实差异就小，要么被风/状态混合（轻微修正）掩盖。
- “重刹车”档位的统计点主要来自 **差动刹车/修正**（大 `servo_diff`）与非稳态段，因此它更像“重刹车 + 转弯/修正”的混合结果，而不是纯“对称重刹车直飞”的性能点。
- 若要得到真正的“刹车极线”，建议后续专门采集每档位的 **对称直飞**，并做相反航向成对估风（见文末建议）。

结论（粗略，均为对地值）:
- 松刹车（brake_ratio≈0.0）→ 下降率≈0.85 m/s，地速≈4.27 m/s，滑翔比≈5.0
- 中刹车（brake_ratio≈0.5）→ 下降率≈0.86 m/s，地速≈4.49 m/s，滑翔比≈5.2
- 重刹车（brake_ratio≈0.9）→ 下降率≈1.32 m/s，地速≈2.81 m/s，滑翔比≈2.1（该档位主要来自修正/弱转弯数据，可靠性低于前两档）

## 估风与对空性能（仅中刹车段可较可靠估计）
用“中刹车 + 对称 + 低转弯率”数据对 `(vx,vy)` 做圆拟合估风（地速点≈同一空速圆 + 风矢量平移）：

| 方法 | 样本 | wind(N) | wind(E) | 风速 | 风向(朝向) | 空速中值 | 拟合RMSE |
|---|---:|---:|---:|---:|---:|---:|---:|
| circle_fit | 191 | -0.61 | -0.07 | 0.61 | -173.4° | 4.27 | 0.48 |

用该风估计修正段1/2 的空速中值约 4.25–4.35 m/s；结合中刹车 `sink_rate≈0.90 m/s`，得到中刹车 **对空滑翔比** 粗估约 `4.27/0.90 ≈ 4.7`（仍需更多“相反航向成对”数据验证）。

## roll=0 转弯率检查（用于左右对称性）
过滤条件: throttle < -0.8、altitude > 3m、h_speed > 1.5m/s、|roll| < 0.05、|servo_diff| < 0.1

| 方向 | 样本 | 转弯率(track)中值(°/s) | yaw_rate(gyro)中值(°/s) | H速度 | 下降率 | 刹车总量 | 刹车差 | 航向 |
|---|---:|---:|---:|---:|---:|---:|---:|---:|
| all | 581 | -0.4 | -1.5 | 4.15 | 0.90 | -0.26 | 0.00 | -95.9 |
| north | 70 | 3.8 | 0.5 | 4.22 | 0.69 | -0.90 | 0.00 | -22.1 |
| south | 73 | -0.6 | 1.6 | 4.61 | 0.73 | 0.00 | 0.00 | 169.9 |

## 建议后续采集（让“极线”更可信）
- 每个刹车档位做 2 个相反航向直飞（每段 ≥20–30s），尽量保持 `servo_diff≈0`，同时记录高度足够（避开地效/强扰动）。
- 采集时优先“稳态”：`|yaw_rate(gyro)|` 小、修正少；否则重刹车档位会被“转弯/修正”污染，导致看起来特别不线性。
- 有了成对航向后：先估风（或用圆拟合/最小二乘），再给出对空 `V-sink` 与 `L/D` 极线。
